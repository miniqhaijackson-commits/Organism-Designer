<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin Sessions â€” J.A.R.V.I.S.</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px;border-bottom:1px solid #eee}
      button{padding:6px}
    </style>
  </head>
  <body>
    <h2>Active Admin Sessions</h2>
    <p>Requires admin session or master token.</p>
    <div>
      <input id="token" placeholder="(optional) manual token for header auth" style="width:60%" />
      <button id="load">Load Sessions</button>
    </div>
    <table>
      <thead><tr><th>Session</th><th>Actor</th><th>Expires</th><th>Actions</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
    <script>
      async function load(){
        const token = document.getElementById('token').value || ''
        const useHeader = !!token
        if(!useHeader){
          // rely on cookie
        }
        const limit = window.__sess_limit || 10
        const offset = window.__sess_offset || 0
        const opts = {}
        if(useHeader){ opts.headers = {'x-admin-session': token} } else { opts.credentials = 'same-origin' }
        const res = await fetch('/api/admin/sessions?limit='+limit+'&offset='+offset, opts)
        if(!res.ok){ alert('failed to load sessions'); return }
        const arr = await res.json()
        const tb = document.getElementById('rows')
        tb.innerHTML = ''
        arr.forEach(s=>{
          const tr = document.createElement('tr')
          const ex = new Date(s.expires_at*1000).toISOString()
          tr.innerHTML = `<td style="word-break:break-all">${s.session_token}</td><td>${s.actor}</td><td>${ex}</td><td><button data-token='${s.session_token}'>Revoke</button></td>`
          tb.appendChild(tr)
        })
        // add pagination controls
        const pager = document.getElementById('pager') || document.createElement('div')
        pager.id = 'pager'
        pager.innerHTML = `<button id="prev">Prev</button> <button id="next">Next</button> <label>limit:<input id="limit" value="${limit}" style="width:60px"/></label>`
        tb.parentNode.insertBefore(pager, tb.nextSibling)
        document.getElementById('next').addEventListener('click', ()=>{ window.__sess_offset = (window.__sess_offset||0) + (parseInt(document.getElementById('limit').value||'10')); window.__sess_limit = parseInt(document.getElementById('limit').value||'10'); load() })
        document.getElementById('prev').addEventListener('click', ()=>{ window.__sess_offset = Math.max(0, (window.__sess_offset||0) - (parseInt(document.getElementById('limit').value||'10'))); window.__sess_limit = parseInt(document.getElementById('limit').value||'10'); load() })
        document.querySelectorAll('button[data-token]').forEach(b=>{
          b.addEventListener('click', async (ev)=>{
            const t = b.getAttribute('data-token')
            if(!confirm('Revoke this session?')) return
            const opts = {method: 'DELETE'}
            if(useHeader){ opts.headers = {'x-admin-session': token} } else { opts.credentials = 'same-origin' }
            const r = await fetch('/api/admin/sessions/' + encodeURIComponent(t), opts)
            if(r.ok){ alert('revoked'); load() } else { alert('revoke failed') }
          })
        })
      }
      document.getElementById('load').addEventListener('click', load)
      // revoke-by-actor control
      const actorDiv = document.createElement('div')
      actorDiv.innerHTML = '<input id="revoke-actor" placeholder="actor"/> <button id="revoke-actor-btn">Revoke All for Actor</button>'
      document.body.insertBefore(actorDiv, document.querySelector('table'))
      document.getElementById('revoke-actor-btn').addEventListener('click', async ()=>{
        const actor = document.getElementById('revoke-actor').value || ''
        if(!actor){ alert('enter actor'); return }
        const token = document.getElementById('token').value || ''
        const useHeader = !!token
        if(!useHeader){ /* rely on cookie */ }
        if(!confirm('Revoke all sessions for actor: ' + actor + '?')) return
        const opts = {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({actor: actor})}
        if(useHeader){ opts.headers['x-admin-session'] = token } else { opts.credentials = 'same-origin' }
        const res = await fetch('/api/admin/revoke_actor', opts)
        if(!res.ok){ alert('revoke actor failed'); return }
        alert('revoked')
        load()
      })
    </script>
  </body>
</html>
