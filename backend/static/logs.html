<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>J.A.R.V.I.S. Audit Logs</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
      textarea{width:100%;height:300px}
      input,button{padding:8px;margin:4px}
      .entry{border-bottom:1px solid #eee;padding:8px 0}
    </style>
  </head>
  <body>
    <h2>Audit Logs</h2>
    <p>Provide a session token or <b>Login</b> to obtain one. Stored session tokens use `localStorage` under <code>jarvis_admin_session</code>.</p>
    <div>
      <input id="token" placeholder="session token or master token" style="width:60%" />
      <button id="load">Load Logs</button>
      <button id="login">Login (exchange master)</button>
      <button id="use-stored">Use stored session</button>
      <button id="save-session">Save session</button>
      <button id="logout">Logout session</button>
    </div>

    <div style="margin-top:12px" class="card">
      <label>Actor: <input id="filter-actor" placeholder="actor" /></label>
      <label>Field: <input id="filter-field" placeholder="field" /></label>
      <label>Since: <input id="filter-since" type="datetime-local" /></label>
      <label>Until: <input id="filter-until" type="datetime-local" /></label>
      <label>Limit: <input id="filter-limit" type="number" value="50" style="width:80px"/></label>
      <button id="prev">Prev</button>
      <button id="next">Next</button>
    </div>

    <div id="out"></div>

    <script>
      async function loadLogs(){
          let token = document.getElementById('token').value;
          if(!token){
            token = localStorage.getItem('jarvis_admin_session') || '';
          }
          if(!token){ alert('Provide session token or login'); return }

          // build query params from filters
          const actor = document.getElementById('filter-actor').value || null
          const field = document.getElementById('filter-field').value || null
          const limit = parseInt(document.getElementById('filter-limit').value || '50')
          const sinceEl = document.getElementById('filter-since').value
          const untilEl = document.getElementById('filter-until').value
          const since = sinceEl ? Math.floor(new Date(sinceEl).getTime()/1000) : null
          const until = untilEl ? Math.floor(new Date(untilEl).getTime()/1000) : null

          const params = new URLSearchParams()
          params.set('limit', String(limit))
          params.set('offset', String(window.__jarvis_offset || 0))
          if(actor) params.set('actor', actor)
          if(field) params.set('field', field)
          if(since) params.set('since', String(since))
          if(until) params.set('until', String(until))

          const res = await fetch('/api/logs?' + params.toString(), {headers: {'x-admin-session': token}});
        if(!res.ok){
          const t = await res.text();
          document.getElementById('out').innerText = 'Error: ' + res.status + ' ' + t;
          return;
        }
        const logs = await res.json();
        const out = document.getElementById('out');
        out.innerHTML = '';
        if(!logs || logs.length===0){ out.innerText = 'No logs'; return }
        logs.forEach(l => {
          const d = new Date(l.timestamp*1000).toISOString();
          const el = document.createElement('div'); el.className='entry';
          el.innerHTML = `<div><b>${d}</b> actor=${l.actor} field=${l.field}</div><div>reason=${String(l.reason)}</div><pre>${JSON.stringify({old:l.old_value,new:l.new_value},null,2)}</pre>`;
          out.appendChild(el);
        })
      }
      document.getElementById('load').addEventListener('click', loadLogs);
      document.getElementById('use-stored').addEventListener('click', ()=>{
        const v = localStorage.getItem('jarvis_admin_session') || ''
        document.getElementById('token').value = v
      })
      document.getElementById('save-session').addEventListener('click', ()=>{
        const v = document.getElementById('token').value || ''
        if(!v){ alert('No session to save'); return }
        localStorage.setItem('jarvis_admin_session', v)
        alert('session saved in localStorage')
      })
      document.getElementById('login').addEventListener('click', async ()=>{
        const master = document.getElementById('token').value || ''
        if(!master){ alert('Enter master token to exchange'); return }
        try{
          const res = await fetch('/api/admin/login', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({master_token: master})})
          if(!res.ok){ const t = await res.text(); alert('Login failed: '+t); return }
          const j = await res.json()
          localStorage.setItem('jarvis_admin_session', j.session_token)
          // clear master token input to avoid accidental leak
          document.getElementById('token').value = ''
          document.getElementById('token').placeholder = 'session acquired'
          alert('session acquired')
        }catch(e){ alert('login error: '+String(e)) }
      })
      document.getElementById('logout').addEventListener('click', async ()=>{
        const session = localStorage.getItem('jarvis_admin_session') || document.getElementById('token').value || ''
        if(!session){ alert('no session to logout'); return }
        try{
          const res = await fetch('/api/admin/logout', {method:'POST', headers:{'x-admin-session': session}})
          if(!res.ok){ const t = await res.text(); alert('Logout failed: '+t); return }
          localStorage.removeItem('jarvis_admin_session')
          alert('session revoked and cleared')
        }catch(e){ alert('logout error: '+String(e)) }
      })

      // pagination
      document.getElementById('next').addEventListener('click', ()=>{
        const limit = parseInt(document.getElementById('filter-limit').value || '50')
        window.__jarvis_offset = (window.__jarvis_offset || 0) + limit
        loadLogs()
      })
      document.getElementById('prev').addEventListener('click', ()=>{
        const limit = parseInt(document.getElementById('filter-limit').value || '50')
        window.__jarvis_offset = Math.max(0, (window.__jarvis_offset || 0) - limit)
        loadLogs()
      })
    </script>
  </body>
</html>
