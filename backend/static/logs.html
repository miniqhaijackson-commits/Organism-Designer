<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>J.A.R.V.I.S. Audit Logs</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
      textarea{width:100%;height:300px}
      input,button{padding:8px;margin:4px}
      .entry{border-bottom:1px solid #eee;padding:8px 0}
    </style>
  </head>
  <body>
    <h2>Audit Logs</h2>
    <p>Login to obtain a short-lived admin session (HttpOnly cookie). You may optionally provide a manual token for API header-based access.</p>
    <div>
      <input id="token" placeholder="(optional) manual token for header auth" style="width:60%" />
      <button id="load">Load Logs</button>
      <button id="login">Login (exchange master)</button>
      <button id="logout">Logout session</button>
    </div>

    <div style="margin-top:12px" class="card">
      <label>Actor: <input id="filter-actor" placeholder="actor" /></label>
      <label>Field: <input id="filter-field" placeholder="field" /></label>
      <label>Since: <input id="filter-since" type="datetime-local" /></label>
      <label>Until: <input id="filter-until" type="datetime-local" /></label>
      <label>Limit: <input id="filter-limit" type="number" value="50" style="width:80px"/></label>
      <button id="prev">Prev</button>
      <button id="next">Next</button>
    </div>

    <div id="out"></div>

    <script>
      async function loadLogs(){
          // If a manual token is provided, use header-based auth. Otherwise rely on the browser cookie set by login.
          let token = document.getElementById('token').value || '';
          const useHeader = !!token
          if(!useHeader){
            // no manual token; rely on cookie (same-origin fetch will send it)
          }

          // build query params from filters
          const actor = document.getElementById('filter-actor').value || null
          const field = document.getElementById('filter-field').value || null
          const limit = parseInt(document.getElementById('filter-limit').value || '50')
          const sinceEl = document.getElementById('filter-since').value
          const untilEl = document.getElementById('filter-until').value
          const since = sinceEl ? Math.floor(new Date(sinceEl).getTime()/1000) : null
          const until = untilEl ? Math.floor(new Date(untilEl).getTime()/1000) : null

          const params = new URLSearchParams()
          params.set('limit', String(limit))
          params.set('offset', String(window.__jarvis_offset || 0))
          if(actor) params.set('actor', actor)
          if(field) params.set('field', field)
          if(since) params.set('since', String(since))
          if(until) params.set('until', String(until))

          const fetchOpts = {}
          if(useHeader){
            fetchOpts.headers = {'x-admin-session': token}
          } else {
            // ensure same-origin cookies are sent
            fetchOpts.credentials = 'same-origin'
          }
          const res = await fetch('/api/logs?' + params.toString(), fetchOpts);
        if(!res.ok){
          const t = await res.text();
          document.getElementById('out').innerText = 'Error: ' + res.status + ' ' + t;
          return;
        }
        const logs = await res.json();
        const out = document.getElementById('out');
        out.innerHTML = '';
        if(!logs || logs.length===0){ out.innerText = 'No logs'; return }
        logs.forEach(l => {
          const d = new Date(l.timestamp*1000).toISOString();
          const el = document.createElement('div'); el.className='entry';
          el.innerHTML = `<div><b>${d}</b> actor=${l.actor} field=${l.field}</div><div>reason=${String(l.reason)}</div><pre>${JSON.stringify({old:l.old_value,new:l.new_value},null,2)}</pre>`;
          out.appendChild(el);
        })
      }
      document.getElementById('load').addEventListener('click', loadLogs);
      document.getElementById('login').addEventListener('click', async ()=>{
        const master = document.getElementById('token').value || ''
        if(!master){ alert('Enter master token to exchange'); return }
        try{
          const res = await fetch('/api/admin/login', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({master_token: master})})
          if(!res.ok){ const t = await res.text(); alert('Login failed: '+t); return }
          // Server sets an HttpOnly cookie; clear master input and inform the user
          document.getElementById('token').value = ''
          alert('Login successful â€” session cookie set. Reload or continue to use admin pages.')
        }catch(e){ alert('login error: '+String(e)) }
      })
      document.getElementById('logout').addEventListener('click', async ()=>{
        const manual = document.getElementById('token').value || ''
        const opts = {method: 'POST'}
        if(manual){ opts.headers = {'x-admin-session': manual} } else { opts.credentials = 'same-origin' }
        try{
          const res = await fetch('/api/admin/logout', opts)
          if(!res.ok){ const t = await res.text(); alert('Logout failed: '+t); return }
          alert('session revoked')
        }catch(e){ alert('logout error: '+String(e)) }
      })

      // pagination
      document.getElementById('next').addEventListener('click', ()=>{
        const limit = parseInt(document.getElementById('filter-limit').value || '50')
        window.__jarvis_offset = (window.__jarvis_offset || 0) + limit
        loadLogs()
      })
      document.getElementById('prev').addEventListener('click', ()=>{
        const limit = parseInt(document.getElementById('filter-limit').value || '50')
        window.__jarvis_offset = Math.max(0, (window.__jarvis_offset || 0) - limit)
        loadLogs()
      })
    </script>
  </body>
</html>
